name: 'CDN Update'
description: 'Publish new or udpated files to the cdn'
inputs:
  update-all:
    description: 'Set to true to update all content in the repo'
    required: false
    default: 'false'
  cdn-bucket:
    description: 'S3 bucket to upload to'
    required: false
    default: 'auditmation-cdn'
runs:
  using: "composite"
  steps:
    - name: check out code
      uses: actions/cache@v4
      with:
        path: .git
        key: ${{ github.repository }}-git-folder

    - name: check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: setup node
      uses: actions/setup-node@v3
      with:
        node-version-file: '.nvmrc'

    - name: configure aws tools creds
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ env.AWS_PUBLISHING_ROLE }}
        role-session-name: ${{ github.event.repository.name }}
        aws-region: ${{ env.AWS_PUBLISHING_REGION }}

    - name: Install nx
      shell: bash
      run: |
        npm install -g nx@20.5.0
      env:
        NPM_TOKEN: ${{ env.READ_TOKEN }}
        ZB_TOKEN: ${{ env.ZB_TOKEN }}

    - name: Install and build affected
      shell: bash
      run: |
        cp .npmrc $HOME/.npmrc
        npm ci
        nx affected -t build --base=origin/main
      env:
        NPM_TOKEN: ${{ env.READ_TOKEN }}
        ZB_TOKEN: ${{ env.ZB_TOKEN }}
        JAVA_OPTS: "-Xms256m -Xmx1024m"

    - name: Update all logos
      shell: bash
      run: |
        if [ "$UPDATE_ALL" == "true" ]; then
          echo "Updating all cdn content"
          PACKAGES=$(npx lerna list --json)
        else 
          echo "Updating changed cdn content"
          PACKAGES=$(npx lerna list --json --since HEAD~1)
        fi

        # Update logos
        echo $PACKAGES | jq -cr '.[].location' | while read pkg; do
          logo=""
          if [ -f "$pkg/logo.svg" ]; then
            logo="$pkg/logo.svg"
          elif [ -f "$pkg/logo.png" ]; then
            logo="$pkg/logo.png"
          fi
          
          if [ "$logo" != "" ] && [ -f "$pkg/index.yml" ]; then
            echo "Updating $pkg logo"
            filename=$(echo $logo | sed 's/^.*package\///')
            filename=$(echo $filename | sed 's/\/logo\./\./')
            filename=$(echo $filename | sed 's/\//-/g')
            echo "Uploading $logo"
            aws s3 cp $logo s3://$CDN_BUCKET/logos/$filename
            echo "Setting logo url"
            logourl="https://cdn.auditmation.io/logos/$filename" yq -i '.logo = env(logourl)' $pkg/index.yml
          fi
        done
      env:
        UPDATE_ALL: ${{ inputs.update-all }}
        CDN_BUCKET: ${{ inputs.cdn-bucket }}

    - uses: EndBug/add-and-commit@v9
      with:
        add: .
        author_name: Marvin the Paranoid Android
        author_email: ci@zerobias.com
        message: 'chore: cdn update'
