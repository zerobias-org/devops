name: 'Content Bundle'
description: 'Runs to create a bundle a repo of zerobias-org content'
inputs:
  publishToken:
    description: Token with permissions to publish packages
    required: true
  update-all:
    description: 'Set to true to update all content in the repo'
    required: false
    default: 'false'
runs:
  using: "composite"
  steps:
    - name: Setup
      shell: bash
      run: |
        echo "REPO_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV

    - name: Update bundle
      id: update
      shell: bash
      run: |
        bash ${{ github.action_path }}/updateBundle.sh
        echo "bundleName=$(cat ./bundle/package.json | jq -r '.name')" >> $GITHUB_OUTPUT
        echo "bundleVersion=$(cat ./bundle/package.json | jq -r '.version')" >> $GITHUB_OUTPUT
      env:
        PUBLISH_TOKEN: ${{ inputs.publishToken }}

    - uses: EndBug/add-and-commit@v9
      with:
        add: ./bundle
        author_name: Marvin the Paranoid Android
        author_email: ci@neverfail.com
        message: 'chore: ⬆ update bundle'
        tag: '${{ steps.update.outputs.bundleName }}@${{ steps.update.outputs.bundleVersion }}'

    - name: Slack Notification
      uses: slackapi/slack-github-action@v2.1.1
      if: success()
      with:
        webhook: ${{ env.SLACK_RELEASES_WEBHOOK }}
        webhook-type: incoming-webhook
        payload: |
          text: "New ${{ github.repository }} Bundle Published"
          attachments:
            - color: "#36a64f"
              fallback: "New Bundle Published"
              title: ":robot: New Bundle Published :tada:"
              text: "${{ steps.update.outputs.bundleName }}@${{ steps.update.outputs.bundleVersion }}"
              footer: "<https://github.com/${{ github.repository }}|${{ github.repository }}> • <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>"
              mrkdwn_in:
                - text
                - footer
