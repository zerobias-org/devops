name: 'Content PR Publish'
description: 'Handle the PR publish flow for zerobias-org content'
runs:
  using: "composite"
  steps:
    - name: Restore git cache
      uses: actions/cache@v4
      with:
        path: .git
        key: ${{ github.repository }}-git-folder

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref_name }}

    - name: Setup node
      uses: zerobias-org/devops/actions/setup-node@main

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.110.0'
        extended: true

    - name: configure git user
      shell: bash
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com

    - uses: actions/download-artifact@v4
      continue-on-error: true
      id: download
      with:
        name: ci-upload
        path: ~/ci-upload

    - name: 'Echo download path'
      shell: bash
      run: echo ${{steps.download.outputs.download-path}}

    - name: Install nx
      shell: bash
      run: |
        npm install -g nx@20.5.0
      env:
        NPM_TOKEN: ${{ env.READ_TOKEN }}
        ZB_TOKEN: ${{ env.ZB_TOKEN }}

    - name: Install dependencies
      shell: bash
      run: |
        cp .npmrc $HOME/.npmrc
        npm ci
        npm install -g @zerobias-org/devops-tools@latest
      env:
        NPM_TOKEN: ${{ env.READ_TOKEN }}
        ZB_TOKEN: ${{ env.ZB_TOKEN }}

    - name: Detect changed packages
      id: detect_changes
      shell: bash
      run: |
        # Detect packages with actual source changes (ignoring lock files)
        CHANGED_DIRS=$(npx detect-changes HEAD~1)
        if [ -z "$CHANGED_DIRS" ]; then
          echo "No packages changed, skipping build/publish"
          echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
        else
          echo "Changed packages:"
          echo "$CHANGED_DIRS"
          # Convert newlines to spaces for safe use in for loops
          CHANGED_DIRS_INLINE=$(echo "$CHANGED_DIRS" | tr '\n' ' ')
          echo "CHANGED_DIRS=$CHANGED_DIRS_INLINE" >> $GITHUB_OUTPUT
          echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
        fi
      env:
        NPM_TOKEN: ${{ env.READ_TOKEN }}
        ZB_TOKEN: ${{ env.ZB_TOKEN }}

    - name: Build changed packages
      if: steps.detect_changes.outputs.HAS_CHANGES == 'true'
      shell: bash
      run: |
        for pkg in ${{ steps.detect_changes.outputs.CHANGED_DIRS }}; do
          echo "Building $pkg"
          (cd "$pkg" && npm run build)
        done
      env:
        NPM_TOKEN: ${{ env.READ_TOKEN }}
        JAVA_OPTS: "-Xms256m -Xmx1024m"

    - name: version
      id: version
      if: steps.detect_changes.outputs.HAS_CHANGES == 'true'
      shell: bash
      run: |
        # Get changed package names
        CHANGED_NAMES=$(npx get-changed-package-names HEAD~1)
        if [ -z "$CHANGED_NAMES" ]; then
          echo "No package names found, skipping version"
          echo "HAS_VERSION_CHANGES=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "Versioning packages:"
        echo "$CHANGED_NAMES"

        # Build comma-separated list for lerna --force-publish
        FORCE_PUBLISH=$(echo "$CHANGED_NAMES" | tr '\n' ',' | sed 's/,$//')

        # Version with prerelease (rc) - separate from publish to avoid lerna publish bug
        npx lerna version --force-publish="$FORCE_PUBLISH" --no-git-tag-version --no-push --conventional-commits --conventional-prerelease --preid rc --yes

        echo "HAS_VERSION_CHANGES=true" >> $GITHUB_OUTPUT

    - name: Commit version changes
      if: steps.version.outputs.HAS_VERSION_CHANGES == 'true'
      uses: EndBug/add-and-commit@v9
      with:
        add: '.'
        message: 'chore(release): bump version'
        default_author: github_actions
        push: true

    - name: publish
      if: steps.version.outputs.HAS_VERSION_CHANGES == 'true'
      shell: bash
      run: |
        # Publish each changed package with rc tag
        for pkg in ${{ steps.detect_changes.outputs.CHANGED_DIRS }}; do
          if [ -f "$pkg/package.json" ]; then
            echo "Publishing $pkg with rc tag"
            (cd "$pkg" && npm publish --tag rc --access public) || echo "Warning: Failed to publish $pkg"
          fi
        done
      env:
        NPM_TOKEN: ${{ env.WRITE_TOKEN }}

    - name: Content Pre-release
      if: steps.detect_changes.outputs.HAS_CHANGES == 'true'
      uses: zerobias-org/devops/nx-actions/content-pre-release@main
      with:
        since: HEAD~1

    - name: Post PR Publish
      if: steps.detect_changes.outputs.HAS_CHANGES == 'true'
      shell: bash
      run: |
        if [ -x scripts/postprpublish.sh ]
        then
          npm config list
          bash scripts/postprpublish.sh
        fi
      env:
        UPLOAD_FOLDER_PATH: ${{steps.download.outputs.download-path}}

    - name: Slack Notification on failure
      uses: slackapi/slack-github-action@v2.1.1
      if: failure() && env.SLACK_DEVOPS_NOTIFICATIONS != ''
      with:
        webhook: ${{ env.SLACK_DEVOPS_NOTIFICATIONS }}
        webhook-type: incoming-webhook
        payload: |
          text: "${{ github.repository }} PR Publish Failed"
          attachments:
            - color: "#ff0000"
              fallback: "PR Publish Failed"
              title: ":fire: ${{ github.repository }} PR Publish Failed"
              text: "Workflow run failed"
              footer: "<https://github.com/${{ github.repository }}|${{ github.repository }}> â€¢ <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>"
              mrkdwn_in:
                - text
                - footer
